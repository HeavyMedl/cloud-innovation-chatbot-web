"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _memoizeOne = _interopRequireDefault(require("memoize-one"));

var _react = _interopRequireDefault(require("react"));

var _best = _interopRequireDefault(require("./best"));

var _Context = _interopRequireDefault(require("./Context"));

var _ScrollSpy = _interopRequireDefault(require("./ScrollSpy"));

var _ScrollTo = _interopRequireDefault(require("./ScrollTo"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function getView() {
  var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      scrollable = _ref.current;

  var _ref2 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
      itemContainer = _ref2.current;

  var scrollingTo = arguments.length > 2 ? arguments[2] : undefined;

  if (itemContainer && scrollable) {
    var scrollLeft = scrollingTo || scrollable.scrollLeft;
    var items = itemContainer.children; // This will enumerate <li> inside <FilmStrip>

    var scrollCenter = scrollLeft + scrollable.offsetWidth / 2;
    var index = (0, _best.default)([].slice.call(items), function (item) {
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      return 1 / Math.abs(scrollCenter - offsetCenter);
    });

    if (~index) {
      var item = items[index];
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      var indexFraction = index + (scrollCenter - offsetCenter) / item.offsetWidth; // We "fix" indexFraction if the viewport is at the start/end of the content
      // This is to simplify code that use Math.round(indexFraction) to find the scrollable index
      // if (scrollLeft === 0) {
      //   indexFraction = 0;
      // } else if (scrollLeft >= scrollable.scrollWidth - scrollable.offsetWidth) {
      //   indexFraction = items.length - 1;
      // } else if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
      //   indexFraction = Math.round(indexFraction);
      // }

      if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
        indexFraction = Math.round(indexFraction);
      }

      var selectedIndex;

      if (scrollLeft === 0) {
        selectedIndex = 0;
      } else if (scrollLeft >= scrollable.scrollWidth - scrollable.offsetWidth) {
        selectedIndex = items.length - 1;
      } else {
        selectedIndex = Math.round(indexFraction);
      }

      return {
        index: selectedIndex,
        indexFraction: indexFraction
      };
    }
  }
}

function getScrollLeft() {
  var _ref3 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      scrollable = _ref3.current;

  var _ref4 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
      itemContainer = _ref4.current;

  var index = arguments.length > 2 ? arguments[2] : undefined;

  if (itemContainer && scrollable) {
    var items = itemContainer.children; // This will enumerate <li> inside <FilmStrip>

    var item = items[Math.max(0, Math.min(items.length - 1, index))];

    if (item) {
      var itemOffsetCenter = item.offsetLeft + item.offsetWidth / 2;
      return itemOffsetCenter - scrollable.offsetWidth / 2;
    }
  }
}

var FilmComposer =
/*#__PURE__*/
function (_React$Component) {
  _inherits(FilmComposer, _React$Component);

  function FilmComposer(props) {
    var _this;

    _classCallCheck(this, FilmComposer);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(FilmComposer).call(this, props));
    _this.handleScroll = _this.handleScroll.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.handleScrollToEnd = _this.handleScrollToEnd.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.itemContainerRef = _react.default.createRef();
    _this.scrollableRef = _react.default.createRef();
    _this.mergeContext = (0, _memoizeOne.default)(function (state) {
      var numItems = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
      return _objectSpread({}, state, {
        numItems: numItems
      });
    });
    _this.state = {
      context: {
        itemContainerRef: _this.itemContainerRef,
        scrollableRef: _this.scrollableRef,
        scrollBarPercentage: '0%',
        scrollBarWidth: '0%',
        scrolling: false,
        scrollTo: function scrollTo(_scrollTo) {
          _this.setState(function (state) {
            var view = getView(_this.scrollableRef, _this.itemContainerRef, state.scrollLeft);

            if (view) {
              var index = view.index,
                  indexFraction = view.indexFraction;

              var targetIndex = _scrollTo({
                index: index,
                indexFraction: indexFraction
              });

              if (typeof targetIndex === 'number') {
                return {
                  scrollLeft: getScrollLeft(_this.scrollableRef, _this.itemContainerRef, targetIndex)
                };
              }
            }
          });
        },
        scrollOneLeft: function scrollOneLeft() {
          _this.state.context.scrollTo(function (_ref5) {
            var indexFraction = _ref5.indexFraction;
            return Math.ceil(indexFraction) - 1;
          });
        },
        scrollOneRight: function scrollOneRight() {
          _this.state.context.scrollTo(function (_ref6) {
            var indexFraction = _ref6.indexFraction;
            return Math.floor(indexFraction) + 1;
          });
        }
      },
      scrollLeft: null
    };
    return _this;
  }

  _createClass(FilmComposer, [{
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      clearTimeout(this.scrollTimeout);
    }
  }, {
    key: "handleScroll",
    value: function handleScroll(_ref7) {
      var _this2 = this;

      var scrollBarPercentage = _ref7.fraction,
          initial = _ref7.initial,
          scrollBarWidth = _ref7.width;
      this.setState(function (_ref8) {
        var context = _ref8.context,
            scrollLeft = _ref8.scrollLeft;
        var view = getView(_this2.scrollableRef, _this2.itemContainerRef, scrollLeft);

        if (view) {
          var index = view.index,
              indexFraction = view.indexFraction;
          return {
            context: _objectSpread({}, context, {
              index: index,
              indexFraction: indexFraction,
              scrolling: !initial,
              scrollBarPercentage: scrollBarPercentage,
              scrollBarWidth: scrollBarWidth
            })
          };
        }
      });

      if (!initial) {
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = setTimeout(function () {
          _this2.setState(function (_ref9) {
            var context = _ref9.context;
            return {
              context: _objectSpread({}, context, {
                scrolling: false
              })
            };
          });
        }, 500);
      }
    }
  }, {
    key: "handleScrollToEnd",
    value: function handleScrollToEnd() {
      this.setState(function () {
        return {
          scrollLeft: null
        };
      });
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props = this.props,
          children = _this$props.children,
          numItems = _this$props.numItems,
          scrollableRef = this.scrollableRef,
          _this$state = this.state,
          context = _this$state.context,
          scrollLeft = _this$state.scrollLeft;
      return _react.default.createElement(_Context.default.Provider, {
        value: this.mergeContext(context, numItems)
      }, children, _react.default.createElement(_ScrollSpy.default, {
        onScroll: this.handleScroll,
        targetRef: scrollableRef
      }), typeof scrollLeft === 'number' && _react.default.createElement(_ScrollTo.default, {
        onEnd: this.handleScrollToEnd,
        scrollLeft: scrollLeft,
        targetRef: scrollableRef
      }));
    }
  }]);

  return FilmComposer;
}(_react.default.Component);

exports.default = FilmComposer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJnZXRWaWV3Iiwic2Nyb2xsYWJsZSIsImN1cnJlbnQiLCJpdGVtQ29udGFpbmVyIiwic2Nyb2xsaW5nVG8iLCJzY3JvbGxMZWZ0IiwiaXRlbXMiLCJjaGlsZHJlbiIsInNjcm9sbENlbnRlciIsIm9mZnNldFdpZHRoIiwiaW5kZXgiLCJzbGljZSIsImNhbGwiLCJpdGVtIiwib2Zmc2V0Q2VudGVyIiwib2Zmc2V0TGVmdCIsIk1hdGgiLCJhYnMiLCJpbmRleEZyYWN0aW9uIiwicm91bmQiLCJzZWxlY3RlZEluZGV4Iiwic2Nyb2xsV2lkdGgiLCJsZW5ndGgiLCJnZXRTY3JvbGxMZWZ0IiwibWF4IiwibWluIiwiaXRlbU9mZnNldENlbnRlciIsIkZpbG1Db21wb3NlciIsInByb3BzIiwiaGFuZGxlU2Nyb2xsIiwiYmluZCIsImhhbmRsZVNjcm9sbFRvRW5kIiwiaXRlbUNvbnRhaW5lclJlZiIsIlJlYWN0IiwiY3JlYXRlUmVmIiwic2Nyb2xsYWJsZVJlZiIsIm1lcmdlQ29udGV4dCIsInN0YXRlIiwibnVtSXRlbXMiLCJjb250ZXh0Iiwic2Nyb2xsQmFyUGVyY2VudGFnZSIsInNjcm9sbEJhcldpZHRoIiwic2Nyb2xsaW5nIiwic2Nyb2xsVG8iLCJzZXRTdGF0ZSIsInZpZXciLCJ0YXJnZXRJbmRleCIsInNjcm9sbE9uZUxlZnQiLCJjZWlsIiwic2Nyb2xsT25lUmlnaHQiLCJmbG9vciIsImNsZWFyVGltZW91dCIsInNjcm9sbFRpbWVvdXQiLCJmcmFjdGlvbiIsImluaXRpYWwiLCJ3aWR0aCIsInNldFRpbWVvdXQiLCJDb21wb25lbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxTQUFTQSxPQUFULEdBSUU7QUFBQSxpRkFIMEIsRUFHMUI7QUFBQSxNQUhXQyxVQUdYLFFBSEVDLE9BR0Y7O0FB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QUFBLFVBSUgrQixRQUpHLGVBSUhBLFFBSkc7QUFBQSxVQU1MSCxhQU5LLEdBV0gsSUFYRyxDQU1MQSxhQU5LO0FBQUEsd0JBV0gsSUFYRyxDQU9MRSxLQVBLO0FBQUEsVUFRSEUsT0FSRyxlQVFIQSxPQVJHO0FBQUEsVUFTSGxDLFVBVEcsZUFTSEEsVUFURztBQWFQLGFBQ0UsNkJBQUMsZ0JBQUQsQ0FBUyxRQUFUO0FBQWtCLFFBQUEsS0FBSyxFQUFHLEtBQUsrQixZQUFMLENBQWtCRyxPQUFsQixFQUEyQkQsUUFBM0I7QUFBMUIsU0FDSS9CLFFBREosRUFFRSw2QkFBQyxrQkFBRDtBQUNFLFFBQUEsUUFBUSxFQUFHLEtBQUtzQixZQURsQjtBQUVFLFFBQUEsU0FBUyxFQUFHTTtBQUZkLFFBRkYsRUFPSSxPQUFPOUIsVUFBUCxLQUFzQixRQUF0QixJQUVFLDZCQUFDLGlCQUFEO0FBQ0UsUUFBQSxLQUFLLEVBQUcsS0FBSzBCLGlCQURmO0FBRUUsUUFBQSxVQUFVLEVBQUcxQixVQUZmO0FBR0UsUUFBQSxTQUFTLEVBQUc4QjtBQUhkLFFBVE4sQ0FERjtBQWtCRDs7OztFQTVIdUNGLGVBQU13QixTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1lbW9pemUgZnJvbSAnbWVtb2l6ZS1vbmUnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IGJlc3QgZnJvbSAnLi9iZXN0JztcbmltcG9ydCBDb250ZXh0IGZyb20gJy4vQ29udGV4dCc7XG5pbXBvcnQgU2Nyb2xsU3B5IGZyb20gJy4vU2Nyb2xsU3B5JztcbmltcG9ydCBTY3JvbGxUbyBmcm9tICcuL1Njcm9sbFRvJztcblxuZnVuY3Rpb24gZ2V0VmlldyhcbiAgeyBjdXJyZW50OiBzY3JvbGxhYmxlIH0gPSB7fSxcbiAgeyBjdXJyZW50OiBpdGVtQ29udGFpbmVyIH0gPSB7fSxcbiAgc2Nyb2xsaW5nVG9cbikge1xuICBpZiAoaXRlbUNvbnRhaW5lciAmJiBzY3JvbGxhYmxlKSB7XG4gICAgY29uc3Qgc2Nyb2xsTGVmdCA9IHNjcm9sbGluZ1RvIHx8IHNjcm9sbGFibGUuc2Nyb2xsTGVmdDtcbiAgICBjb25zdCBpdGVtcyA9IGl0ZW1Db250YWluZXIuY2hpbGRyZW47IC8vIFRoaXMgd2lsbCBlbnVtZXJhdGUgPGxpPiBpbnNpZGUgPEZpbG1TdHJpcD5cbiAgICBjb25zdCBzY3JvbGxDZW50ZXIgPSBzY3JvbGxMZWZ0ICsgc2Nyb2xsYWJsZS5vZmZzZXRXaWR0aCAvIDI7XG4gICAgY29uc3QgaW5kZXggPSBiZXN0KFtdLnNsaWNlLmNhbGwoaXRlbXMpLCBpdGVtID0+IHtcbiAgICAgIGNvbnN0IG9mZnNldENlbnRlciA9IGl0ZW0ub2Zmc2V0TGVmdCArIGl0ZW0ub2Zmc2V0V2lkdGggLyAyO1xuXG4gICAgICByZXR1cm4gMSAvIE1hdGguYWJzKHNjcm9sbENlbnRlciAtIG9mZnNldENlbnRlcik7XG4gICAgfSk7XG5cbiAgICBpZiAofmluZGV4KSB7XG4gICAgICBjb25zdCBpdGVtID0gaXRlbXNbaW5kZXhdO1xuICAgICAgY29uc3Qgb2Zmc2V0Q2VudGVyID0gaXRlbS5vZmZzZXRMZWZ0ICsgaXRlbS5vZmZzZXRXaWR0aCAvIDI7XG4gICAgICBsZXQgaW5kZXhGcmFjdGlvbiA9IGluZGV4ICsgKHNjcm9sbENlbnRlciAtIG9mZnNldENlbnRlcikgLyBpdGVtLm9mZnNldFdpZHRoO1xuXG4gICAgICAvLyBXZSBcImZpeFwiIGluZGV4RnJhY3Rpb24gaWYgdGhlIHZpZXdwb3J0IGlzIGF0IHRoZSBzdGFydC9lbmQgb2YgdGhlIGNvbnRlbnRcbiAgICAgIC8vIFRoaXMgaXMgdG8gc2ltcGxpZnkgY29kZSB0aGF0IHVzZSBNYXRoLnJvdW5kKGluZGV4RnJhY3Rpb24pIHRvIGZpbmQgdGhlIHNjcm9sbGFibGUgaW5kZXhcbiAgICAgIC8vIGlmIChzY3JvbGxMZWZ0ID09PSAwKSB7XG4gICAgICAvLyAgIGluZGV4RnJhY3Rpb24gPSAwO1xuICAgICAgLy8gfSBlbHNlIGlmIChzY3JvbGxMZWZ0ID49IHNjcm9sbGFibGUuc2Nyb2xsV2lkdGggLSBzY3JvbGxhYmxlLm9mZnNldFdpZHRoKSB7XG4gICAgICAvLyAgIGluZGV4RnJhY3Rpb24gPSBpdGVtcy5sZW5ndGggLSAxO1xuICAgICAgLy8gfSBlbHNlIGlmIChpbmRleEZyYWN0aW9uICUgMSA+IC45OSB8fCBpbmRleEZyYWN0aW9uICUgMSA8IC4wMSkge1xuICAgICAgLy8gICBpbmRleEZyYWN0aW9uID0gTWF0aC5yb3VuZChpbmRleEZyYWN0aW9uKTtcbiAgICAgIC8vIH1cblxuICAgICAgaWYgKGluZGV4RnJhY3Rpb24gJSAxID4gLjk5IHx8IGluZGV4RnJhY3Rpb24gJSAxIDwgLjAxKSB7XG4gICAgICAgIGluZGV4RnJhY3Rpb24gPSBNYXRoLnJvdW5kKGluZGV4RnJhY3Rpb24pO1xuICAgICAgfVxuXG4gICAgICBsZXQgc2VsZWN0ZWRJbmRleDtcblxuICAgICAgaWYgKHNjcm9sbExlZnQgPT09IDApIHtcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IDA7XG4gICAgICB9IGVsc2UgaWYgKHNjcm9sbExlZnQgPj0gc2Nyb2xsYWJsZS5zY3JvbGxXaWR0aCAtIHNjcm9sbGFibGUub2Zmc2V0V2lkdGgpIHtcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IGl0ZW1zLmxlbmd0aCAtIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZWxlY3RlZEluZGV4ID0gTWF0aC5yb3VuZChpbmRleEZyYWN0aW9uKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaW5kZXg6IHNlbGVjdGVkSW5kZXgsXG4gICAgICAgIGluZGV4RnJhY3Rpb25cbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFNjcm9sbExlZnQoXG4gIHsgY3VycmVudDogc2Nyb2xsYWJsZSB9ID0ge30sXG4gIHsgY3VycmVudDogaXRlbUNvbnRhaW5lciB9ID0ge30sXG4gIGluZGV4XG4pIHtcbiAgaWYgKGl0ZW1Db250YWluZXIgJiYgc2Nyb2xsYWJsZSkge1xuICAgIGNvbnN0IGl0ZW1zID0gaXRlbUNvbnRhaW5lci5jaGlsZHJlbjsgLy8gVGhpcyB3aWxsIGVudW1lcmF0ZSA8bGk+IGluc2lkZSA8RmlsbVN0cmlwPlxuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1tNYXRoLm1heCgwLCBNYXRoLm1pbihpdGVtcy5sZW5ndGggLSAxLCBpbmRleCkpXTtcblxuICAgIGlmIChpdGVtKSB7XG4gICAgICBjb25zdCBpdGVtT2Zmc2V0Q2VudGVyID0gaXRlbS5vZmZzZXRMZWZ0ICsgaXRlbS5vZmZzZXRXaWR0aCAvIDI7XG5cbiAgICAgIHJldHVybiBpdGVtT2Zmc2V0Q2VudGVyIC0gc2Nyb2xsYWJsZS5vZmZzZXRXaWR0aCAvIDI7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZpbG1Db21wb3NlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5oYW5kbGVTY3JvbGwgPSB0aGlzLmhhbmRsZVNjcm9sbC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuaGFuZGxlU2Nyb2xsVG9FbmQgPSB0aGlzLmhhbmRsZVNjcm9sbFRvRW5kLmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLml0ZW1Db250YWluZXJSZWYgPSBSZWFjdC5jcmVhdGVSZWYoKTtcbiAgICB0aGlzLnNjcm9sbGFibGVSZWYgPSBSZWFjdC5jcmVhdGVSZWYoKTtcblxuICAgIHRoaXMubWVyZ2VDb250ZXh0ID0gbWVtb2l6ZSgoc3RhdGUsIG51bUl0ZW1zID0gMCkgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgbnVtSXRlbXNcbiAgICB9KSk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgY29udGV4dDoge1xuICAgICAgICBpdGVtQ29udGFpbmVyUmVmOiB0aGlzLml0ZW1Db250YWluZXJSZWYsXG4gICAgICAgIHNjcm9sbGFibGVSZWY6IHRoaXMuc2Nyb2xsYWJsZVJlZixcbiAgICAgICAgc2Nyb2xsQmFyUGVyY2VudGFnZTogJzAlJyxcbiAgICAgICAgc2Nyb2xsQmFyV2lkdGg6ICcwJScsXG4gICAgICAgIHNjcm9sbGluZzogZmFsc2UsXG4gICAgICAgIHNjcm9sbFRvOiBzY3JvbGxUbyA9PiB7XG4gICAgICAgICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2aWV3ID0gZ2V0Vmlldyh0aGlzLnNjcm9sbGFibGVSZWYsIHRoaXMuaXRlbUNvbnRhaW5lclJlZiwgc3RhdGUuc2Nyb2xsTGVmdCk7XG5cbiAgICAgICAgICAgIGlmICh2aWV3KSB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgaW5kZXgsIGluZGV4RnJhY3Rpb24gfSA9IHZpZXc7XG4gICAgICAgICAgICAgIGNvbnN0IHRhcmdldEluZGV4ID0gc2Nyb2xsVG8oeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9KTtcblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldEluZGV4ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHNjcm9sbExlZnQ6IGdldFNjcm9sbExlZnQodGhpcy5zY3JvbGxhYmxlUmVmLCB0aGlzLml0ZW1Db250YWluZXJSZWYsIHRhcmdldEluZGV4KSB9O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHNjcm9sbE9uZUxlZnQ6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLnN0YXRlLmNvbnRleHQuc2Nyb2xsVG8oKHsgaW5kZXhGcmFjdGlvbiB9KSA9PiBNYXRoLmNlaWwoaW5kZXhGcmFjdGlvbikgLSAxKTtcbiAgICAgICAgfSxcbiAgICAgICAgc2Nyb2xsT25lUmlnaHQ6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLnN0YXRlLmNvbnRleHQuc2Nyb2xsVG8oKHsgaW5kZXhGcmFjdGlvbiB9KSA9PiBNYXRoLmZsb29yKGluZGV4RnJhY3Rpb24pICsgMSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBzY3JvbGxMZWZ0OiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLnNjcm9sbFRpbWVvdXQpO1xuICB9XG5cbiAgaGFuZGxlU2Nyb2xsKHtcbiAgICBmcmFjdGlvbjogc2Nyb2xsQmFyUGVyY2VudGFnZSxcbiAgICBpbml0aWFsLFxuICAgIHdpZHRoOiBzY3JvbGxCYXJXaWR0aFxuICB9KSB7XG4gICAgdGhpcy5zZXRTdGF0ZSgoeyBjb250ZXh0LCBzY3JvbGxMZWZ0IH0pID0+IHtcbiAgICAgIGNvbnN0IHZpZXcgPSBnZXRWaWV3KHRoaXMuc2Nyb2xsYWJsZVJlZiwgdGhpcy5pdGVtQ29udGFpbmVyUmVmLCBzY3JvbGxMZWZ0KTtcblxuICAgICAgaWYgKHZpZXcpIHtcbiAgICAgICAgY29uc3QgeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9ID0gdmlldztcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGluZGV4RnJhY3Rpb24sXG4gICAgICAgICAgICBzY3JvbGxpbmc6ICFpbml0aWFsLFxuICAgICAgICAgICAgc2Nyb2xsQmFyUGVyY2VudGFnZSxcbiAgICAgICAgICAgIHNjcm9sbEJhcldpZHRoXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKCFpbml0aWFsKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zY3JvbGxUaW1lb3V0KTtcblxuICAgICAgdGhpcy5zY3JvbGxUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoKHsgY29udGV4dCB9KSA9PiAoe1xuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICBzY3JvbGxpbmc6IGZhbHNlXG4gICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgICB9LCA1MDApO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVNjcm9sbFRvRW5kKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHsgc2Nyb2xsTGVmdDogbnVsbCB9KSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgcHJvcHM6IHtcbiAgICAgICAgY2hpbGRyZW4sXG4gICAgICAgIG51bUl0ZW1zXG4gICAgICB9LFxuICAgICAgc2Nyb2xsYWJsZVJlZixcbiAgICAgIHN0YXRlOiB7XG4gICAgICAgIGNvbnRleHQsXG4gICAgICAgIHNjcm9sbExlZnRcbiAgICAgIH1cbiAgICB9ID0gdGhpcztcblxuICAgIHJldHVybiAoXG4gICAgICA8Q29udGV4dC5Qcm92aWRlciB2YWx1ZT17IHRoaXMubWVyZ2VDb250ZXh0KGNvbnRleHQsIG51bUl0ZW1zKSB9PlxuICAgICAgICB7IGNoaWxkcmVuIH1cbiAgICAgICAgPFNjcm9sbFNweVxuICAgICAgICAgIG9uU2Nyb2xsPXsgdGhpcy5oYW5kbGVTY3JvbGwgfVxuICAgICAgICAgIHRhcmdldFJlZj17IHNjcm9sbGFibGVSZWYgfVxuICAgICAgICAvPlxuICAgICAgICB7XG4gICAgICAgICAgdHlwZW9mIHNjcm9sbExlZnQgPT09ICdudW1iZXInXG4gICAgICAgICAgJiZcbiAgICAgICAgICAgIDxTY3JvbGxUb1xuICAgICAgICAgICAgICBvbkVuZD17IHRoaXMuaGFuZGxlU2Nyb2xsVG9FbmQgfVxuICAgICAgICAgICAgICBzY3JvbGxMZWZ0PXsgc2Nyb2xsTGVmdCB9XG4gICAgICAgICAgICAgIHRhcmdldFJlZj17IHNjcm9sbGFibGVSZWYgfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgfVxuICAgICAgPC9Db250ZXh0LlByb3ZpZGVyPlxuICAgICk7XG4gIH1cbn1cbiJdfQ==