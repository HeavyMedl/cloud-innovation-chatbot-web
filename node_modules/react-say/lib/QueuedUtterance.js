"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _createDeferred = _interopRequireDefault(require("./createDeferred"));

function createNativeUtterance(utteranceLike, ponyfill) {
  var speechSynthesis = ponyfill.speechSynthesis,
      SpeechSynthesisUtterance = ponyfill.SpeechSynthesisUtterance;
  var lang = utteranceLike.lang,
      onBoundary = utteranceLike.onBoundary,
      pitch = utteranceLike.pitch,
      rate = utteranceLike.rate,
      text = utteranceLike.text,
      voice = utteranceLike.voice,
      volume = utteranceLike.volume;
  var utterance = new SpeechSynthesisUtterance(text);
  var targetVoice;

  if (typeof voice === 'function') {
    targetVoice = voice.call(speechSynthesis, speechSynthesis.getVoices());
  } else {
    var _ref = voice || {},
        voiceURI = _ref.voiceURI;

    targetVoice = voiceURI && [].find.call([].slice.call(speechSynthesis.getVoices()), function (v) {
      return v.voiceURI === voiceURI;
    });
  } // Edge will mute if "lang" is set to ""


  utterance.lang = lang || '';

  if (pitch || pitch === 0) {
    utterance.pitch = pitch;
  }

  if (rate || rate === 0) {
    utterance.rate = rate;
  } // Cognitive Services will error when "voice" is set to "null"
  // Edge will error when "voice" is set to "undefined"


  if (targetVoice) {
    utterance.voice = targetVoice;
  }

  if (volume || volume === 0) {
    utterance.volume = volume;
  }

  if (utterance.addEventListener && onBoundary) {
    utterance.addEventListener('boundary', onBoundary); // Since browser quirks, start/error/end events are emulated for best compatibility
  }

  return utterance;
}

function speakUtterance(_x, _x2, _x3) {
  return _speakUtterance.apply(this, arguments);
}

function _speakUtterance() {
  _speakUtterance = (0, _asyncToGenerator2["default"])(
  /*#__PURE__*/
  _regenerator["default"].mark(function _callee4(ponyfill, utteranceLike, startCallback) {
    var speechSynthesis, utterance, startDeferred, errorDeferred, endDeferred, startEvent, finishedSpeaking, endPromise, endEvent;
    return _regenerator["default"].wrap(function _callee4$(_context4) {
      while (1) {
        switch (_context4.prev = _context4.next) {
          case 0:
            speechSynthesis = ponyfill.speechSynthesis;
            utterance = createNativeUtterance(utteranceLike, ponyfill);
            startDeferred = (0, _createDeferred["default"])();
            errorDeferred = (0, _createDeferred["default"])();
            endDeferred = (0, _createDeferred["default"])();
            utterance.addEventListener('end', endDeferred.resolve);
            utterance.addEventListener('error', errorDeferred.resolve);
            utterance.addEventListener('start', startDeferred.resolve); // if (speechSynthesis.speaking) {
            //   console.warn(`ASSERTION: speechSynthesis.speaking should not be truthy before we call speak`);
            // }

            speechSynthesis.speak(utterance); // await startDeferred.promise;

            _context4.next = 11;
            return Promise.race([errorDeferred.promise, startDeferred.promise]);

          case 11:
            startEvent = _context4.sent;

            if (!(startEvent.type === 'error')) {
              _context4.next = 14;
              break;
            }

            throw startEvent.error;

          case 14:
            endPromise = Promise.race([errorDeferred.promise, endDeferred.promise]);
            startCallback && startCallback(
            /*#__PURE__*/
            (0, _asyncToGenerator2["default"])(
            /*#__PURE__*/
            _regenerator["default"].mark(function _callee3() {
              return _regenerator["default"].wrap(function _callee3$(_context3) {
                while (1) {
                  switch (_context3.prev = _context3.next) {
                    case 0:
                      if (finishedSpeaking) {
                        _context3.next = 4;
                        break;
                      }

                      speechSynthesis.cancel();
                      _context3.next = 4;
                      return endPromise;

                    case 4:
                    case "end":
                      return _context3.stop();
                  }
                }
              }, _callee3);
            })));
            _context4.next = 18;
            return endPromise;

          case 18:
            endEvent = _context4.sent;
            finishedSpeaking = true; // if (speechSynthesis.speaking) {
            //   console.warn(`ASSERTION: speechSynthesis.speaking should not be truthy after speak is stopped`);
            // }
            // console.debug(`ENDED: ${ utterance.text }`);

            if (!(endEvent.type === 'error')) {
              _context4.next = 22;
              break;
            }

            throw endEvent.error;

          case 22:
          case "end":
            return _context4.stop();
        }
      }
    }, _callee4);
  }));
  return _speakUtterance.apply(this, arguments);
}

var QueuedUtterance =
/*#__PURE__*/
function () {
  function QueuedUtterance(utteranceLike) {
    (0, _classCallCheck2["default"])(this, QueuedUtterance);
    this._cancelled = false;
    this._deferred = (0, _createDeferred["default"])();
    this._ponyfill = null;
    this._speaking = false;
    this._utteranceLike = utteranceLike;
    this.id = utteranceLike.id;
    this.promise = this._deferred.promise;
  }

  (0, _createClass2["default"])(QueuedUtterance, [{
    key: "cancel",
    value: function () {
      var _cancel = (0, _asyncToGenerator2["default"])(
      /*#__PURE__*/
      _regenerator["default"].mark(function _callee() {
        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                this._cancelled = true;
                _context.t0 = this._cancel;

                if (!_context.t0) {
                  _context.next = 5;
                  break;
                }

                _context.next = 5;
                return this._cancel();

              case 5:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function cancel() {
        return _cancel.apply(this, arguments);
      }

      return cancel;
    }()
  }, {
    key: "speak",
    value: function speak(ponyfill) {
      var _this = this;

      (0, _asyncToGenerator2["default"])(
      /*#__PURE__*/
      _regenerator["default"].mark(function _callee2() {
        return _regenerator["default"].wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                if (!_this._cancelled) {
                  _context2.next = 2;
                  break;
                }

                throw new Error('cancelled');

              case 2:
                _context2.next = 4;
                return speakUtterance(ponyfill, _this._utteranceLike, function (cancel) {
                  if (_this._cancelled) {
                    cancel();
                  } else {
                    _this._cancel = cancel;
                    _this._utteranceLike.onStart && _this._utteranceLike.onStart(new Event('start'));
                  }
                });

              case 4:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2);
      }))().then(function () {
        if (_this._cancelled) {
          throw new Error('cancelled');
        }
      }).then(function () {
        _this._utteranceLike.onEnd && _this._utteranceLike.onEnd(new Event('end'));

        _this._deferred.resolve();
      }, function (error) {
        var event = new Event('error');
        event.error = error;
        _this._utteranceLike.onError && _this._utteranceLike.onError(event);

        _this._deferred.reject(error);
      });
      return this.promise;
    }
  }]);
  return QueuedUtterance;
}();

exports["default"] = QueuedUtterance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9RdWV1ZWRVdHRlcmFuY2UuanMiXSwibmFtZXMiOlsiY3JlYXRlTmF0aXZlVXR0ZXJhbmNlIiwidXR0ZXJhbmNlTGlrZSIsInBvbnlmaWxsIiwic3BlZWNoU3ludGhlc2lzIiwiU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlIiwibGFuZyIsIm9uQm91bmRhcnkiLCJwaXRjaCIsInJhdGUiLCJ0ZXh0Iiwidm9pY2UiLCJ2b2x1bWUiLCJ1dHRlcmFuY2UiLCJ0YXJnZXRWb2ljZSIsImNhbGwiLCJnZXRWb2ljZXMiLCJ2b2ljZVVSSSIsImZpbmQiLCJzbGljZSIsInYiLCJhZGRFdmVudExpc3RlbmVyIiwic3BlYWtVdHRlcmFuY2UiLCJzdGFydENhbGxiYWNrIiwic3RhcnREZWZlcnJlZCIsImVycm9yRGVmZXJyZWQiLCJlbmREZWZlcnJlZCIsInJlc29sdmUiLCJzcGVhayIsIlByb21pc2UiLCJyYWNlIiwicHJvbWlzZSIsInN0YXJ0RXZlbnQiLCJ0eXBlIiwiZXJyb3IiLCJlbmRQcm9taXNlIiwiZmluaXNoZWRTcGVha2luZyIsImNhbmNlbCIsImVuZEV2ZW50IiwiUXVldWVkVXR0ZXJhbmNlIiwiX2NhbmNlbGxlZCIsIl9kZWZlcnJlZCIsIl9wb255ZmlsbCIsIl9zcGVha2luZyIsIl91dHRlcmFuY2VMaWtlIiwiaWQiLCJfY2FuY2VsIiwiRXJyb3IiLCJvblN0YXJ0IiwiRXZlbnQiLCJ0aGVuIiwib25FbmQiLCJldmVudCIsIm9uRXJyb3IiLCJyZWplY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUEsU0FBU0EscUJBQVQsQ0FBK0JDLGFBQS9CLEVBQThDQyxRQUE5QyxFQUF3RDtBQUFBLE1BQzlDQyxlQUQ4QyxHQUNBRCxRQURBLENBQzlDQyxlQUQ4QztBQUFBLE1BQzdCQyx3QkFENkIsR0FDQUYsUUFEQSxDQUM3QkUsd0JBRDZCO0FBQUEsTUFHcERDLElBSG9ELEdBVWxESixhQVZrRCxDQUdwREksSUFIb0Q7QUFB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S0FBSixDQUFVLFdBQVYsQ0FBTjtBQUNEO0FBQ0YsT0FqQkQsRUFpQkdHLElBakJILENBaUJRLFlBQU07QUFDWixRQUFBLEtBQUksQ0FBQ04sY0FBTCxDQUFvQk8sS0FBcEIsSUFBNkIsS0FBSSxDQUFDUCxjQUFMLENBQW9CTyxLQUFwQixDQUEwQixJQUFJRixLQUFKLENBQVUsS0FBVixDQUExQixDQUE3Qjs7QUFDQSxRQUFBLEtBQUksQ0FBQ1IsU0FBTCxDQUFlZCxPQUFmO0FBQ0QsT0FwQkQsRUFvQkcsVUFBQU8sS0FBSyxFQUFJO0FBQ1YsWUFBTWtCLEtBQUssR0FBRyxJQUFJSCxLQUFKLENBQVUsT0FBVixDQUFkO0FBRUFHLFFBQUFBLEtBQUssQ0FBQ2xCLEtBQU4sR0FBY0EsS0FBZDtBQUVBLFFBQUEsS0FBSSxDQUFDVSxjQUFMLENBQW9CUyxPQUFwQixJQUErQixLQUFJLENBQUNULGNBQUwsQ0FBb0JTLE9BQXBCLENBQTRCRCxLQUE1QixDQUEvQjs7QUFDQSxRQUFBLEtBQUksQ0FBQ1gsU0FBTCxDQUFlYSxNQUFmLENBQXNCcEIsS0FBdEI7QUFDRCxPQTNCRDtBQTZCQSxhQUFPLEtBQUtILE9BQVo7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcmVhdGVEZWZlcnJlZCBmcm9tICcuL2NyZWF0ZURlZmVycmVkJztcblxuZnVuY3Rpb24gY3JlYXRlTmF0aXZlVXR0ZXJhbmNlKHV0dGVyYW5jZUxpa2UsIHBvbnlmaWxsKSB7XG4gIGNvbnN0IHsgc3BlZWNoU3ludGhlc2lzLCBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UgfSA9IHBvbnlmaWxsO1xuICBjb25zdCB7XG4gICAgbGFuZyxcbiAgICBvbkJvdW5kYXJ5LFxuICAgIHBpdGNoLFxuICAgIHJhdGUsXG4gICAgdGV4dCxcbiAgICB2b2ljZSxcbiAgICB2b2x1bWVcbiAgfSA9IHV0dGVyYW5jZUxpa2U7XG4gIGNvbnN0IHV0dGVyYW5jZSA9IG5ldyBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UodGV4dCk7XG4gIGxldCB0YXJnZXRWb2ljZTtcblxuICBpZiAodHlwZW9mIHZvaWNlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgdGFyZ2V0Vm9pY2UgPSB2b2ljZS5jYWxsKHNwZWVjaFN5bnRoZXNpcywgc3BlZWNoU3ludGhlc2lzLmdldFZvaWNlcygpKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCB7IHZvaWNlVVJJIH0gPSB2b2ljZSB8fCB7fTtcblxuICAgIHRhcmdldFZvaWNlID0gdm9pY2VVUkkgJiYgW10uZmluZC5jYWxsKFtdLnNsaWNlLmNhbGwoc3BlZWNoU3ludGhlc2lzLmdldFZvaWNlcygpKSwgdiA9PiB2LnZvaWNlVVJJID09PSB2b2ljZVVSSSk7XG4gIH1cblxuICAvLyBFZGdlIHdpbGwgbXV0ZSBpZiBcImxhbmdcIiBpcyBzZXQgdG8gXCJcIlxuICB1dHRlcmFuY2UubGFuZyA9IGxhbmcgfHwgJyc7XG5cbiAgaWYgKHBpdGNoIHx8IHBpdGNoID09PSAwKSB7XG4gICAgdXR0ZXJhbmNlLnBpdGNoID0gcGl0Y2g7XG4gIH1cblxuICBpZiAocmF0ZSB8fCByYXRlID09PSAwKSB7XG4gICAgdXR0ZXJhbmNlLnJhdGUgPSByYXRlO1xuICB9XG5cbiAgLy8gQ29nbml0aXZlIFNlcnZpY2VzIHdpbGwgZXJyb3Igd2hlbiBcInZvaWNlXCIgaXMgc2V0IHRvIFwibnVsbFwiXG4gIC8vIEVkZ2Ugd2lsbCBlcnJvciB3aGVuIFwidm9pY2VcIiBpcyBzZXQgdG8gXCJ1bmRlZmluZWRcIlxuICBpZiAodGFyZ2V0Vm9pY2UpIHtcbiAgICB1dHRlcmFuY2Uudm9pY2UgPSB0YXJnZXRWb2ljZTtcbiAgfVxuXG4gIGlmICh2b2x1bWUgfHwgdm9sdW1lID09PSAwKSB7XG4gICAgdXR0ZXJhbmNlLnZvbHVtZSA9IHZvbHVtZTtcbiAgfVxuXG4gIGlmICh1dHRlcmFuY2UuYWRkRXZlbnRMaXN0ZW5lciAmJiBvbkJvdW5kYXJ5KSB7XG4gICAgdXR0ZXJhbmNlLmFkZEV2ZW50TGlzdGVuZXIoJ2JvdW5kYXJ5Jywgb25Cb3VuZGFyeSk7XG5cbiAgICAvLyBTaW5jZSBicm93c2VyIHF1aXJrcywgc3RhcnQvZXJyb3IvZW5kIGV2ZW50cyBhcmUgZW11bGF0ZWQgZm9yIGJlc3QgY29tcGF0aWJpbGl0eVxuICB9XG5cbiAgcmV0dXJuIHV0dGVyYW5jZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3BlYWtVdHRlcmFuY2UocG9ueWZpbGwsIHV0dGVyYW5jZUxpa2UsIHN0YXJ0Q2FsbGJhY2spIHtcbiAgY29uc3QgeyBzcGVlY2hTeW50aGVzaXMgfSA9IHBvbnlmaWxsO1xuXG4gIGNvbnN0IHV0dGVyYW5jZSA9IGNyZWF0ZU5hdGl2ZVV0dGVyYW5jZSh1dHRlcmFuY2VMaWtlLCBwb255ZmlsbCk7XG4gIGNvbnN0IHN0YXJ0RGVmZXJyZWQgPSBjcmVhdGVEZWZlcnJlZCgpO1xuICBjb25zdCBlcnJvckRlZmVycmVkID0gY3JlYXRlRGVmZXJyZWQoKTtcbiAgY29uc3QgZW5kRGVmZXJyZWQgPSBjcmVhdGVEZWZlcnJlZCgpO1xuXG4gIHV0dGVyYW5jZS5hZGRFdmVudExpc3RlbmVyKCdlbmQnLCBlbmREZWZlcnJlZC5yZXNvbHZlKTtcbiAgdXR0ZXJhbmNlLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZXJyb3JEZWZlcnJlZC5yZXNvbHZlKTtcbiAgdXR0ZXJhbmNlLmFkZEV2ZW50TGlzdGVuZXIoJ3N0YXJ0Jywgc3RhcnREZWZlcnJlZC5yZXNvbHZlKTtcblxuICAvLyBpZiAoc3BlZWNoU3ludGhlc2lzLnNwZWFraW5nKSB7XG4gIC8vICAgY29uc29sZS53YXJuKGBBU1NFUlRJT046IHNwZWVjaFN5bnRoZXNpcy5zcGVha2luZyBzaG91bGQgbm90IGJlIHRydXRoeSBiZWZvcmUgd2UgY2FsbCBzcGVha2ApO1xuICAvLyB9XG5cbiAgc3BlZWNoU3ludGhlc2lzLnNwZWFrKHV0dGVyYW5jZSk7XG5cbiAgLy8gYXdhaXQgc3RhcnREZWZlcnJlZC5wcm9taXNlO1xuXG4gIGNvbnN0IHN0YXJ0RXZlbnQgPSBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgIGVycm9yRGVmZXJyZWQucHJvbWlzZSxcbiAgICBzdGFydERlZmVycmVkLnByb21pc2VcbiAgXSk7XG5cbiAgaWYgKHN0YXJ0RXZlbnQudHlwZSA9PT0gJ2Vycm9yJykge1xuICAgIHRocm93IHN0YXJ0RXZlbnQuZXJyb3I7XG4gIH1cblxuICAvLyBjb25zb2xlLmRlYnVnKGBTVEFSVEVEOiAkeyB1dHRlcmFuY2UudGV4dCB9YCk7XG5cbiAgbGV0IGZpbmlzaGVkU3BlYWtpbmc7XG4gIGNvbnN0IGVuZFByb21pc2UgPSBQcm9taXNlLnJhY2UoW1xuICAgIGVycm9yRGVmZXJyZWQucHJvbWlzZSxcbiAgICBlbmREZWZlcnJlZC5wcm9taXNlXG4gIF0pO1xuXG4gIHN0YXJ0Q2FsbGJhY2sgJiYgc3RhcnRDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgaWYgKCFmaW5pc2hlZFNwZWFraW5nKSB7XG4gICAgICBzcGVlY2hTeW50aGVzaXMuY2FuY2VsKCk7XG4gICAgICBhd2FpdCBlbmRQcm9taXNlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgZW5kRXZlbnQgPSBhd2FpdCBlbmRQcm9taXNlO1xuXG4gIGZpbmlzaGVkU3BlYWtpbmcgPSB0cnVlO1xuXG4gIC8vIGlmIChzcGVlY2hTeW50aGVzaXMuc3BlYWtpbmcpIHtcbiAgLy8gICBjb25zb2xlLndhcm4oYEFTU0VSVElPTjogc3BlZWNoU3ludGhlc2lzLnNwZWFraW5nIHNob3VsZCBub3QgYmUgdHJ1dGh5IGFmdGVyIHNwZWFrIGlzIHN0b3BwZWRgKTtcbiAgLy8gfVxuXG4gIC8vIGNvbnNvbGUuZGVidWcoYEVOREVEOiAkeyB1dHRlcmFuY2UudGV4dCB9YCk7XG5cbiAgaWYgKGVuZEV2ZW50LnR5cGUgPT09ICdlcnJvcicpIHtcbiAgICB0aHJvdyBlbmRFdmVudC5lcnJvcjtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRdWV1ZWRVdHRlcmFuY2Uge1xuICBjb25zdHJ1Y3Rvcih1dHRlcmFuY2VMaWtlKSB7XG4gICAgdGhpcy5fY2FuY2VsbGVkID0gZmFsc2U7XG4gICAgdGhpcy5fZGVmZXJyZWQgPSBjcmVhdGVEZWZlcnJlZCgpO1xuICAgIHRoaXMuX3BvbnlmaWxsID0gbnVsbDtcbiAgICB0aGlzLl9zcGVha2luZyA9IGZhbHNlO1xuICAgIHRoaXMuX3V0dGVyYW5jZUxpa2UgPSB1dHRlcmFuY2VMaWtlO1xuXG4gICAgdGhpcy5pZCA9IHV0dGVyYW5jZUxpa2UuaWQ7XG4gICAgdGhpcy5wcm9taXNlID0gdGhpcy5fZGVmZXJyZWQucHJvbWlzZTtcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbCgpIHtcbiAgICB0aGlzLl9jYW5jZWxsZWQgPSB0cnVlO1xuICAgIHRoaXMuX2NhbmNlbCAmJiBhd2FpdCB0aGlzLl9jYW5jZWwoKTtcbiAgfVxuXG4gIHNwZWFrKHBvbnlmaWxsKSB7XG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgIGlmICh0aGlzLl9jYW5jZWxsZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjYW5jZWxsZWQnKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgc3BlYWtVdHRlcmFuY2UocG9ueWZpbGwsIHRoaXMuX3V0dGVyYW5jZUxpa2UsIGNhbmNlbCA9PiB7XG4gICAgICAgIGlmICh0aGlzLl9jYW5jZWxsZWQpIHtcbiAgICAgICAgICBjYW5jZWwoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9jYW5jZWwgPSBjYW5jZWw7XG4gICAgICAgICAgdGhpcy5fdXR0ZXJhbmNlTGlrZS5vblN0YXJ0ICYmIHRoaXMuX3V0dGVyYW5jZUxpa2Uub25TdGFydChuZXcgRXZlbnQoJ3N0YXJ0JykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KSgpLnRoZW4oKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuX2NhbmNlbGxlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbmNlbGxlZCcpO1xuICAgICAgfVxuICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5fdXR0ZXJhbmNlTGlrZS5vbkVuZCAmJiB0aGlzLl91dHRlcmFuY2VMaWtlLm9uRW5kKG5ldyBFdmVudCgnZW5kJykpO1xuICAgICAgdGhpcy5fZGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgIH0sIGVycm9yID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IEV2ZW50KCdlcnJvcicpO1xuXG4gICAgICBldmVudC5lcnJvciA9IGVycm9yO1xuXG4gICAgICB0aGlzLl91dHRlcmFuY2VMaWtlLm9uRXJyb3IgJiYgdGhpcy5fdXR0ZXJhbmNlTGlrZS5vbkVycm9yKGV2ZW50KTtcbiAgICAgIHRoaXMuX2RlZmVycmVkLnJlamVjdChlcnJvcik7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5wcm9taXNlO1xuICB9XG59XG4iXX0=