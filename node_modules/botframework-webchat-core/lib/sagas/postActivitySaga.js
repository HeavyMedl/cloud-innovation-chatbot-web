"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _callee3;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _effects = require("redux-saga/effects");

var _observeOnce = _interopRequireDefault(require("./effects/observeOnce"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

var _language = _interopRequireDefault(require("../selectors/language"));

var _sendTimeout = _interopRequireDefault(require("../selectors/sendTimeout"));

var _deleteKey = _interopRequireDefault(require("../utils/deleteKey"));

var _getTimestamp = _interopRequireDefault(require("../utils/getTimestamp"));

var _sleep = _interopRequireDefault(require("../utils/sleep"));

var _uniqueID = _interopRequireDefault(require("../utils/uniqueID"));

var _postActivity = require("../actions/postActivity");

var _incomingActivity = require("../actions/incomingActivity");

var _marked =
/*#__PURE__*/
_regenerator["default"].mark(_callee3),
    _marked2 =
/*#__PURE__*/
_regenerator["default"].mark(postActivity);

function _callee3() {
  return _regenerator["default"].wrap(function _callee3$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          _context3.next = 2;
          return (0, _whileConnected["default"])(
          /*#__PURE__*/
          _regenerator["default"].mark(function _callee2(_ref) {
            var directLine, userID, username, numActivitiesPosted;
            return _regenerator["default"].wrap(function _callee2$(_context2) {
              while (1) {
                switch (_context2.prev = _context2.next) {
                  case 0:
                    directLine = _ref.directLine, userID = _ref.userID, username = _ref.username;
                    numActivitiesPosted = 0;
                    _context2.next = 4;
                    return (0, _effects.takeEvery)(_postActivity.POST_ACTIVITY,
                    /*#__PURE__*/
                    _regenerator["default"].mark(function _callee(action) {
                      return _regenerator["default"].wrap(function _callee$(_context) {
                        while (1) {
                          switch (_context.prev = _context.next) {
                            case 0:
                              return _context.delegateYield(postActivity(directLine, userID, username, numActivitiesPosted++, action), "t0", 1);

                            case 1:
                            case "end":
                              return _context.stop();
                          }
                        }
                      }, _callee);
                    }));

                  case 4:
                  case "end":
                    return _context2.stop();
                }
              }
            }, _callee2);
          }));

        case 2:
        case "end":
          return _context3.stop();
      }
    }
  }, _marked);
}

function postActivity(directLine, userID, username, numActivitiesPosted, _ref2) {
  var method, activity, locale, _activity, attachments, _activity$channelData, _activity$channelData2, clientActivityID, meta, echoBackCall, sendTimeout, _ref5, echoBack;

  return _regenerator["default"].wrap(function postActivity$(_context5) {
    while (1) {
      switch (_context5.prev = _context5.next) {
        case 0:
          method = _ref2.meta.method, activity = _ref2.payload.activity;
          _context5.next = 3;
          return (0, _effects.select)(_language["default"]);

        case 3:
          locale = _context5.sent;
          _activity = activity, attachments = _activity.attachments, _activity$channelData = _activity.channelData;
          _activity$channelData = _activity$channelData === void 0 ? {} : _activity$channelData;
          _activity$channelData2 = _activity$channelData.clientActivityID, clientActivityID = _activity$channelData2 === void 0 ? (0, _uniqueID["default"])() : _activity$channelData2;
          activity = (0, _objectSpread2["default"])({}, (0, _deleteKey["default"])(activity, 'id'), {
            attachments: attachments && attachments.map(function (_ref3) {
              var contentType = _ref3.contentType,
                  contentUrl = _ref3.contentUrl,
                  name = _ref3.name;
              return {
                contentType: contentType,
                contentUrl: contentUrl,
                name: name
              };
            }),
            channelData: (0, _objectSpread2["default"])({
              clientActivityID: clientActivityID
            }, (0, _deleteKey["default"])(activity.channelData, 'state')),
            channelId: 'webchat',
            from: {
              id: userID,
              name: username,
              role: 'user'
            },
            locale: locale,
            timestamp: (0, _getTimestamp["default"])()
          });

          if (!numActivitiesPosted) {
            activity.entities = [].concat((0, _toConsumableArray2["default"])(activity.entities || []), [{
              // TODO: [P4] Currently in v3, we send the capabilities although the client might not actually have them
              //       We need to understand why we need to send these, and only send capabilities the client have
              requiresBotState: true,
              supportsListening: true,
              supportsTts: true,
              type: 'ClientCapabilities'
            }]);
          }

          meta = {
            clientActivityID: clientActivityID,
            method: method
          };
          _context5.next = 12;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_PENDING,
            meta: meta,
            payload: {
              activity: activity
            }
          });

        case 12:
          _context5.prev = 12;
          // Quirks: We might receive INCOMING_ACTIVITY before the postActivity call completed
          //         So, we setup expectation first, then postActivity afterward
          echoBackCall = (0, _effects.call)(
          /*#__PURE__*/
          _regenerator["default"].mark(function _callee4() {
            var _ref4, _activity2, _activity2$channelDat, channelData, id;

            return _regenerator["default"].wrap(function _callee4$(_context4) {
              while (1) {
                switch (_context4.prev = _context4.next) {
                  case 0:
                    _context4.next = 2;
                    return (0, _effects.take)(_incomingActivity.INCOMING_ACTIVITY);

                  case 2:
                    _ref4 = _context4.sent;
                    _activity2 = _ref4.payload.activity;
                    _activity2$channelDat = _activity2.channelData, channelData = _activity2$channelDat === void 0 ? {} : _activity2$channelDat, id = _activity2.id;

                    if (!(channelData.clientActivityID === clientActivityID && id)) {
                      _context4.next = 7;
                      break;
                    }

                    return _context4.abrupt("return", _activity2);

                  case 7:
                    _context4.next = 0;
                    break;

                  case 9:
                  case "end":
                    return _context4.stop();
                }
              }
            }, _callee4);
          })); // Timeout could be due to either:
          // - Post activity call may take too long time to complete
          //   - Direct Line service only respond on HTTP after bot respond to Direct Line
          // - Activity may take too long time to echo back

          _context5.next = 16;
          return (0, _effects.select)(_sendTimeout["default"]);

        case 16:
          sendTimeout = _context5.sent;
          _context5.next = 19;
          return (0, _effects.race)({
            send: (0, _effects.all)({
              echoBack: echoBackCall,
              postActivity: (0, _observeOnce["default"])(directLine.postActivity(activity))
            }),
            timeout: (0, _effects.call)(function () {
              return (0, _sleep["default"])(sendTimeout).then(function () {
                return Promise.reject(new Error('timeout'));
              });
            })
          });

        case 19:
          _ref5 = _context5.sent;
          echoBack = _ref5.send.echoBack;
          _context5.next = 23;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_FULFILLED,
            meta: meta,
            payload: {
              activity: echoBack
            }
          });

        case 23:
          _context5.next = 29;
          break;

        case 25:
          _context5.prev = 25;
          _context5.t0 = _context5["catch"](12);
          _context5.next = 29;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: _context5.t0
          });

        case 29:
          _context5.prev = 29;
          _context5.next = 32;
          return (0, _effects.cancelled)();

        case 32:
          if (!_context5.sent) {
            _context5.next = 35;
            break;
          }

          _context5.next = 35;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: new Error('cancelled')
          });

        case 35:
          return _context5.finish(29);

        case 36:
        case "end":
          return _context5.stop();
      }
    }
  }, _marked2, null, [[12, 25, 29, 36]]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9wb3N0QWN0aXZpdHlTYWdhLmpzIl0sIm5hbWVzIjpbInBvc3RBY3Rpdml0eSIsImRpcmVjdExpbmUiLCJ1c2VySUQiLCJ1c2VybmFtZSIsIm51bUFjdGl2aXRpZXNQb3N0ZWQiLCJQT1NUX0FDVElWSVRZIiwiYWN0aW9uIiwibWV0aG9kIiwibWV0YSIsImFjdGl2aXR5IiwicGF5bG9hZCIsImxhbmd1YWdlU2VsZWN0b3IiLCJsb2NhbGUiLCJhdHRhY2htZW50cyIsImNoYW5uZWxEYXRhIiwiY2xpZW50QWN0aXZpdHlJRCIsIm1hcCIsImNvbnRlbnRUeXBlIiwiY29udGVudFVybCIsIm5hbWUiLCJjaGFubmVsSWQiLCJmcm9tIiwiaWQiLCJyb2xlIiwidGltZXN0YW1wIiwiZW50aXRpZXMiLCJyZXF1aXJlc0JvdFN0YXRlIiwic3VwcG9ydHNMaXN0ZW5pbmciLCJzdXBwb3J0c1R0cyIsInR5cGUiLCJQT1NUX0FDVElWSVRZX1BFTkRJTkciLCJlY2hvQmFja0NhbGwiLCJJTkNPTUlOR19BQ1RJVklUWSIsInNlbmRUaW1lb3V0U2VsZWN0b3IiLCJzZW5kVGltZW91dCIsInNlbmQiLCJlY2hvQmFjayIsInRpbWVvdXQiLCJ0aGVuIiwiUHJvbWlzZSIsInJlamVjdCIsIkVycm9yIiwiUE9TVF9BQ1RJVklUWV9GVUxGSUxMRUQiLCJQT1NUX0FDVElWSVRZX1JFSkVDVEVEIiwiZXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQVdBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQU9BOzs7Ozs7OzZCQVlVQSxZOztBQVZLO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUNiLGlCQUFNO0FBQUE7QUFBQSx1Q0FBZTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBYUMsb0JBQUFBLFVBQWIsUUFBYUEsVUFBYixFQUF5QkMsTUFBekIsUUFBeUJBLE1BQXpCLEVBQWlD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QUFBQSxRQTlEcEIsU0E4RFlELElBOURaLENBOERvQkMsUUE5RHBCO0FBQUE7QUFzRUksaUJBQU0sa0JBQUk7QUFBRVAsWUFBQUEsSUFBSSxFQUFFYSxxQ0FBUjtBQUFpQ2xDLFlBQUFBLElBQUksRUFBSkEsSUFBakM7QUFBdUNFLFlBQUFBLE9BQU8sRUFBRTtBQUFFRCxjQUFBQSxRQUFRLEVBQUUyQjtBQUFaO0FBQWhELFdBQUosQ0FBTjs7QUF0RUo7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBd0VJLGlCQUFNLGtCQUFJO0FBQUVQLFlBQUFBLElBQUksRUFBRWMsb0NBQVI7QUFBZ0NDLFlBQUFBLEtBQUssRUFBRSxJQUF2QztBQUE2Q3BDLFlBQUFBLElBQUksRUFBSkEsSUFBN0M7QUFBbURFLFlBQUFBLE9BQU87QUFBMUQsV0FBSixDQUFOOztBQXhFSjtBQUFBO0FBQUE7QUEwRVEsaUJBQU0seUJBQU47O0FBMUVSO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUEyRU0saUJBQU0sa0JBQUk7QUFBRW1CLFlBQUFBLElBQUksRUFBRWMsb0NBQVI7QUFBZ0NDLFlBQUFBLEtBQUssRUFBRSxJQUF2QztBQUE2Q3BDLFlBQUFBLElBQUksRUFBSkEsSUFBN0M7QUFBbURFLFlBQUFBLE9BQU8sRUFBRSxJQUFJK0IsS0FBSixDQUFVLFdBQVY7QUFBNUQsV0FBSixDQUFOOztBQTNFTjtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgYWxsLFxuICBjYWxsLFxuICBjYW5jZWxsZWQsXG4gIHB1dCxcbiAgcmFjZSxcbiAgc2VsZWN0LFxuICB0YWtlLFxuICB0YWtlRXZlcnlcbn0gZnJvbSAncmVkdXgtc2FnYS9lZmZlY3RzJztcblxuaW1wb3J0IG9ic2VydmVPbmNlIGZyb20gJy4vZWZmZWN0cy9vYnNlcnZlT25jZSc7XG5pbXBvcnQgd2hpbGVDb25uZWN0ZWQgZnJvbSAnLi9lZmZlY3RzL3doaWxlQ29ubmVjdGVkJztcblxuaW1wb3J0IGxhbmd1YWdlU2VsZWN0b3IgZnJvbSAnLi4vc2VsZWN0b3JzL2xhbmd1YWdlJztcbmltcG9ydCBzZW5kVGltZW91dFNlbGVjdG9yIGZyb20gJy4uL3NlbGVjdG9ycy9zZW5kVGltZW91dCc7XG5cbmltcG9ydCBkZWxldGVLZXkgZnJvbSAnLi4vdXRpbHMvZGVsZXRlS2V5JztcbmltcG9ydCBnZXRUaW1lc3RhbXAgZnJvbSAnLi4vdXRpbHMvZ2V0VGltZXN0YW1wJztcbmltcG9ydCBzbGVlcCBmcm9tICcuLi91dGlscy9zbGVlcCc7XG5pbXBvcnQgdW5pcXVlSUQgZnJvbSAnLi4vdXRpbHMvdW5pcXVlSUQnO1xuXG5pbXBvcnQge1xuICBQT1NUX0FDVElWSVRZLFxuICBQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCxcbiAgUE9TVF9BQ1RJVklUWV9QRU5ESU5HLFxuICBQT1NUX0FDVElWSVRZX1JFSkVDVEVEXG59IGZyb20gJy4uL2FjdGlvbnMvcG9zdEFjdGl2aXR5JztcblxuaW1wb3J0IHsgSU5DT01JTkdfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL2luY29taW5nQWN0aXZpdHknO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiogKCkge1xuICB5aWVsZCB3aGlsZUNvbm5lY3RlZChmdW5jdGlvbiogKHsgZGlyZWN0TGluZSwgdXNlcklELCB1c2VybmFtZSB9KSB7XG4gICAgbGV0IG51bUFjdGl2aXRpZXNQb3N0ZWQgPSAwO1xuXG4gICAgeWllbGQgdGFrZUV2ZXJ5KFBPU1RfQUNUSVZJVFksIGZ1bmN0aW9uKiAoYWN0aW9uKSB7XG4gICAgICB5aWVsZCogcG9zdEFjdGl2aXR5KGRpcmVjdExpbmUsIHVzZXJJRCwgdXNlcm5hbWUsIG51bUFjdGl2aXRpZXNQb3N0ZWQrKywgYWN0aW9uKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uKiBwb3N0QWN0aXZpdHkoZGlyZWN0TGluZSwgdXNlcklELCB1c2VybmFtZSwgbnVtQWN0aXZpdGllc1Bvc3RlZCwgeyBtZXRhOiB7IG1ldGhvZCB9LCBwYXlsb2FkOiB7IGFjdGl2aXR5IH0gfSkge1xuICBjb25zdCBsb2NhbGUgPSB5aWVsZCBzZWxlY3QobGFuZ3VhZ2VTZWxlY3Rvcik7XG4gIGNvbnN0IHsgYXR0YWNobWVudHMsIGNoYW5uZWxEYXRhOiB7IGNsaWVudEFjdGl2aXR5SUQgPSB1bmlxdWVJRCgpIH0gPSB7fSB9ID0gYWN0aXZpdHk7XG5cbiAgYWN0aXZpdHkgPSB7XG4gICAgLi4uZGVsZXRlS2V5KGFjdGl2aXR5LCAnaWQnKSxcbiAgICBhdHRhY2htZW50czogYXR0YWNobWVudHMgJiYgYXR0YWNobWVudHMubWFwKCh7IGNvbnRlbnRUeXBlLCBjb250ZW50VXJsLCBuYW1lIH0pID0+ICh7XG4gICAgICBjb250ZW50VHlwZSxcbiAgICAgIGNvbnRlbnRVcmwsXG4gICAgICBuYW1lXG4gICAgfSkpLFxuICAgIGNoYW5uZWxEYXRhOiB7XG4gICAgICBjbGllbnRBY3Rpdml0eUlELFxuICAgICAgLi4uZGVsZXRlS2V5KGFjdGl2aXR5LmNoYW5uZWxEYXRhLCAnc3RhdGUnKVxuICAgIH0sXG4gICAgY2hhbm5lbElkOiAnd2ViY2hhdCcsXG4gICAgZnJvbToge1xuICAgICAgaWQ6IHVzZXJJRCxcbiAgICAgIG5hbWU6IHVzZXJuYW1lLFxuICAgICAgcm9sZTogJ3VzZXInXG4gICAgfSxcbiAgICBsb2NhbGUsXG4gICAgdGltZXN0YW1wOiBnZXRUaW1lc3RhbXAoKVxuICB9O1xuXG4gIGlmICghbnVtQWN0aXZpdGllc1Bvc3RlZCkge1xuICAgIGFjdGl2aXR5LmVudGl0aWVzID0gWy4uLmFjdGl2aXR5LmVudGl0aWVzIHx8IFtdLCB7XG4gICAgICAvLyBUT0RPOiBbUDRdIEN1cnJlbnRseSBpbiB2Mywgd2Ugc2VuZCB0aGUgY2FwYWJpbGl0aWVzIGFsdGhvdWdoIHRoZSBjbGllbnQgbWlnaHQgbm90IGFjdHVhbGx5IGhhdmUgdGhlbVxuICAgICAgLy8gICAgICAgV2UgbmVlZCB0byB1bmRlcnN0YW5kIHdoeSB3ZSBuZWVkIHRvIHNlbmQgdGhlc2UsIGFuZCBvbmx5IHNlbmQgY2FwYWJpbGl0aWVzIHRoZSBjbGllbnQgaGF2ZVxuICAgICAgcmVxdWlyZXNCb3RTdGF0ZTogdHJ1ZSxcbiAgICAgIHN1cHBvcnRzTGlzdGVuaW5nOiB0cnVlLFxuICAgICAgc3VwcG9ydHNUdHM6IHRydWUsXG4gICAgICB0eXBlOiAnQ2xpZW50Q2FwYWJpbGl0aWVzJ1xuICAgIH1dO1xuICB9XG5cbiAgY29uc3QgbWV0YSA9IHsgY2xpZW50QWN0aXZpdHlJRCwgbWV0aG9kIH07XG5cbiAgeWllbGQgcHV0KHsgdHlwZTogUE9TVF9BQ1RJVklUWV9QRU5ESU5HLCBtZXRhLCBwYXlsb2FkOiB7IGFjdGl2aXR5IH0gfSk7XG5cbiAgdHJ5IHtcbiAgICAvLyBRdWlya3M6IFdlIG1pZ2h0IHJlY2VpdmUgSU5DT01JTkdfQUNUSVZJVFkgYmVmb3JlIHRoZSBwb3N0QWN0aXZpdHkgY2FsbCBjb21wbGV0ZWRcbiAgICAvLyAgICAgICAgIFNvLCB3ZSBzZXR1cCBleHBlY3RhdGlvbiBmaXJzdCwgdGhlbiBwb3N0QWN0aXZpdHkgYWZ0ZXJ3YXJkXG5cbiAgICBjb25zdCBlY2hvQmFja0NhbGwgPSBjYWxsKGZ1bmN0aW9uKiAoKSB7XG4gICAgICBmb3IgKDs7KSB7XG4gICAgICAgIGNvbnN0IHsgcGF5bG9hZDogeyBhY3Rpdml0eSB9IH0gPSB5aWVsZCB0YWtlKElOQ09NSU5HX0FDVElWSVRZKTtcbiAgICAgICAgY29uc3QgeyBjaGFubmVsRGF0YSA9IHt9LCBpZCB9ID0gYWN0aXZpdHk7XG5cbiAgICAgICAgaWYgKGNoYW5uZWxEYXRhLmNsaWVudEFjdGl2aXR5SUQgPT09IGNsaWVudEFjdGl2aXR5SUQgJiYgaWQpIHtcbiAgICAgICAgICByZXR1cm4gYWN0aXZpdHk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFRpbWVvdXQgY291bGQgYmUgZHVlIHRvIGVpdGhlcjpcbiAgICAvLyAtIFBvc3QgYWN0aXZpdHkgY2FsbCBtYXkgdGFrZSB0b28gbG9uZyB0aW1lIHRvIGNvbXBsZXRlXG4gICAgLy8gICAtIERpcmVjdCBMaW5lIHNlcnZpY2Ugb25seSByZXNwb25kIG9uIEhUVFAgYWZ0ZXIgYm90IHJlc3BvbmQgdG8gRGlyZWN0IExpbmVcbiAgICAvLyAtIEFjdGl2aXR5IG1heSB0YWtlIHRvbyBsb25nIHRpbWUgdG8gZWNobyBiYWNrXG5cbiAgICBjb25zdCBzZW5kVGltZW91dCA9IHlpZWxkIHNlbGVjdChzZW5kVGltZW91dFNlbGVjdG9yKTtcblxuICAgIGNvbnN0IHsgc2VuZDogeyBlY2hvQmFjayB9IH0gPSB5aWVsZCByYWNlKHtcbiAgICAgIHNlbmQ6IGFsbCh7XG4gICAgICAgIGVjaG9CYWNrOiBlY2hvQmFja0NhbGwsXG4gICAgICAgIHBvc3RBY3Rpdml0eTogb2JzZXJ2ZU9uY2UoZGlyZWN0TGluZS5wb3N0QWN0aXZpdHkoYWN0aXZpdHkpKVxuICAgICAgfSksXG4gICAgICB0aW1lb3V0OiBjYWxsKCgpID0+IHNsZWVwKHNlbmRUaW1lb3V0KS50aGVuKCgpID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigndGltZW91dCcpKSkpXG4gICAgfSk7XG5cbiAgICB5aWVsZCBwdXQoeyB0eXBlOiBQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCwgbWV0YSwgcGF5bG9hZDogeyBhY3Rpdml0eTogZWNob0JhY2sgfSB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgeWllbGQgcHV0KHsgdHlwZTogUE9TVF9BQ1RJVklUWV9SRUpFQ1RFRCwgZXJyb3I6IHRydWUsIG1ldGEsIHBheWxvYWQ6IGVyciB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoeWllbGQgY2FuY2VsbGVkKCkpIHtcbiAgICAgIHlpZWxkIHB1dCh7IHR5cGU6IFBPU1RfQUNUSVZJVFlfUkVKRUNURUQsIGVycm9yOiB0cnVlLCBtZXRhLCBwYXlsb2FkOiBuZXcgRXJyb3IoJ2NhbmNlbGxlZCcpIH0pO1xuICAgIH1cbiAgfVxufVxuIl19