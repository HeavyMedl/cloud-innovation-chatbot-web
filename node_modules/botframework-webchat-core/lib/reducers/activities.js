"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _simpleUpdateIn = _interopRequireDefault(require("simple-update-in"));

var _deleteActivity = require("../actions/deleteActivity");

var _incomingActivity = require("../actions/incomingActivity");

var _markActivity = require("../actions/markActivity");

var _postActivity = require("../actions/postActivity");

var _ActivityClientState = require("../constants/ActivityClientState");

var DEFAULT_STATE = [];

function getClientActivityID(_ref) {
  var _ref$channelData = _ref.channelData;
  _ref$channelData = _ref$channelData === void 0 ? {} : _ref$channelData;
  var clientActivityID = _ref$channelData.clientActivityID;
  return clientActivityID;
}

function findByClientActivityID(clientActivityID) {
  return function (activity) {
    return getClientActivityID(activity) === clientActivityID;
  };
}

function upsertActivityWithSort(activities, nextActivity) {
  var _nextActivity$channel = nextActivity.channelData;
  _nextActivity$channel = _nextActivity$channel === void 0 ? {} : _nextActivity$channel;
  var nextClientActivityID = _nextActivity$channel.clientActivityID,
      _nextActivity$from = nextActivity.from;
  _nextActivity$from = _nextActivity$from === void 0 ? {} : _nextActivity$from;
  var nextFromID = _nextActivity$from.id,
      nextFromRole = _nextActivity$from.role,
      nextType = nextActivity.type;

  if (nextType === 'typing' && nextFromRole === 'user') {
    return activities;
  }

  var nextTimestamp = Date.parse(nextActivity.timestamp);
  var nextActivities = activities.filter(function (_ref2) {
    var _ref2$channelData = _ref2.channelData;
    _ref2$channelData = _ref2$channelData === void 0 ? {} : _ref2$channelData;
    var clientActivityID = _ref2$channelData.clientActivityID,
        from = _ref2.from,
        type = _ref2.type;
    return (// We will remove all "typing" and "sending messages" activities
      // "clientActivityID" is unique and used to track if the message has been sent and echoed back from the server
      !(type === 'typing' && from.id === nextFromID || nextClientActivityID && clientActivityID === nextClientActivityID)
    );
  }); // Then, find the right (sorted) place to insert the new activity at, based on timestamp, and must be before "typing"
  // Since clockskew might happen, we will ignore timestamp on messages that are sending
  // If we are inserting "typing", we will always append it
  // TODO: [P4] Move "typing" into Constants.ActivityType

  var indexToInsert = nextActivity.type === 'typing' ? -1 : nextActivities.findIndex(function (_ref3) {
    var _ref3$channelData = _ref3.channelData;
    _ref3$channelData = _ref3$channelData === void 0 ? {} : _ref3$channelData;
    var state = _ref3$channelData.state,
        timestamp = _ref3.timestamp,
        type = _ref3.type;
    return Date.parse(timestamp) > nextTimestamp && state !== _ActivityClientState.SENDING && state !== _ActivityClientState.SEND_FAILED || type === 'typing';
  }); // If no right place are found, append it

  nextActivities.splice(~indexToInsert ? indexToInsert : nextActivities.length, 0, nextActivity);
  return nextActivities;
}

function _default() {
  var state = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : DEFAULT_STATE;

  var _ref4 = arguments.length > 1 ? arguments[1] : undefined,
      meta = _ref4.meta,
      payload = _ref4.payload,
      type = _ref4.type;

  switch (type) {
    case _deleteActivity.DELETE_ACTIVITY:
      state = (0, _simpleUpdateIn["default"])(state, [function (_ref5) {
        var id = _ref5.id;
        return id === payload.activityID;
      }]);
      break;

    case _markActivity.MARK_ACTIVITY:
      state = (0, _simpleUpdateIn["default"])(state, [function (_ref6) {
        var id = _ref6.id;
        return id === payload.activityID;
      }, 'channelData', payload.name], function () {
        return payload.value;
      });
      break;

    case _postActivity.POST_ACTIVITY_PENDING:
      state = upsertActivityWithSort(state, (0, _simpleUpdateIn["default"])(payload.activity, ['channelData', 'state'], function () {
        return _ActivityClientState.SENDING;
      }));
      break;

    case _postActivity.POST_ACTIVITY_REJECTED:
      state = (0, _simpleUpdateIn["default"])(state, [findByClientActivityID(meta.clientActivityID), 'channelData', 'state'], function () {
        return _ActivityClientState.SEND_FAILED;
      });
      break;

    case _postActivity.POST_ACTIVITY_FULFILLED:
      state = (0, _simpleUpdateIn["default"])(state, [findByClientActivityID(meta.clientActivityID)], function (activity) {
        return (// We will replace the activity with the version from the server
          (0, _simpleUpdateIn["default"])(payload.activity, ['channelData', 'state'], function () {
            return _ActivityClientState.SENT;
          })
        );
      });
      break;

    case _incomingActivity.INCOMING_ACTIVITY:
      // UpdateActivity is not supported right now because we ignore duplicated activity ID
      if (!~state.findIndex(function (_ref7) {
        var id = _ref7.id;
        return id === payload.activity.id;
      })) {
        state = upsertActivityWithSort(state, payload.activity);
      }

      break;

    default:
      break;
  }

  return state;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWR1Y2Vycy9hY3Rpdml0aWVzLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfU1RBVEUiLCJnZXRDbGllbnRBY3Rpdml0eUlEIiwiY2hhbm5lbERhdGEiLCJjbGllbnRBY3Rpdml0eUlEIiwiZmluZEJ5Q2xpZW50QWN0aXZpdHlJRCIsImFjdGl2aXR5IiwidXBzZXJ0QWN0aXZpdHlXaXRoU29ydCIsImFjdGl2aXRpZXMiLCJuZXh0QWN0aXZpdHkiLCJuZXh0Q2xpZW50QWN0aXZpdHlJRCIsImZyb20iLCJuZXh0RnJvbUlEIiwiaWQiLCJuZXh0RnJvbVJvbGUiLCJyb2xlIiwibmV4dFR5cGUiLCJ0eXBlIiwibmV4dFRpbWVzdGFtcCIsIkRhdGUiLCJwYXJzZSIsInRpbWVzdGFtcCIsIm5leHRBY3Rpdml0aWVzIiwiZmlsdGVyIiwiaW5kZXhUb0luc2VydCIsImZpbmRJbmRleCIsInN0YXRlIiwiU0VORElORyIsIlNFTkRfRkFJTEVEIiwic3BsaWNlIiwibGVuZ3RoIiwibWV0YSIsInBheWxvYWQiLCJERUxFVEVfQUNUSVZJVFkiLCJhY3Rpdml0eUlEIiwiTUFSS19BQ1RJVklUWSIsIm5hbWUiLCJ2YWx1ZSIsIlBPU1RfQUNUSVZJVFlfUEVORElORyIsIlBPU1RfQUNUSVZJVFlfUkVKRUNURUQiLCJQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCIsIlNFTlQiLCJJTkNPTUlOR19BQ1RJVklUWSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBTUE7O0FBRUEsSUFBTUEsYUFBYSxHQUFHLEVBQXRCOztBQUVBLFNBQVNDLG1CQUFULE9BQXlFO0FBQUEsOEJBQTFDQyxXQUEwQztBQUFBLG1EQUFOLEVBQU07QUFBQSxNQUEzQkMsZ0JBQTJCLG9CQUEzQkEsZ0JBQTJCO0FBQ3ZFLFNBQU9BLGdCQUFQO0FBQ0Q7O0FBRUQsU0FBU0Msc0JBQVQsQ0FBZ0NELGdCQUFoQyxFQUFrRDtBQUNoRCxTQUFPLFVBQUFF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O0FBQzdEYSxRQUFBQSxLQUFLLEdBQUduQixzQkFBc0IsQ0FBQ21CLEtBQUQsRUFBUU0sT0FBTyxDQUFDMUIsUUFBaEIsQ0FBOUI7QUFDRDs7QUFFRDs7QUFFRjtBQUFTO0FBakNYOztBQW9DQSxTQUFPb0IsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHVwZGF0ZUluIGZyb20gJ3NpbXBsZS11cGRhdGUtaW4nO1xuXG5pbXBvcnQgeyBERUxFVEVfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL2RlbGV0ZUFjdGl2aXR5JztcbmltcG9ydCB7IElOQ09NSU5HX0FDVElWSVRZIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmNvbWluZ0FjdGl2aXR5JztcbmltcG9ydCB7IE1BUktfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL21hcmtBY3Rpdml0eSc7XG5cbmltcG9ydCB7XG4gIFBPU1RfQUNUSVZJVFlfRlVMRklMTEVELFxuICBQT1NUX0FDVElWSVRZX1BFTkRJTkcsXG4gIFBPU1RfQUNUSVZJVFlfUkVKRUNURURcbn0gZnJvbSAnLi4vYWN0aW9ucy9wb3N0QWN0aXZpdHknO1xuXG5pbXBvcnQgeyBTRU5EX0ZBSUxFRCwgU0VORElORywgU0VOVCB9IGZyb20gJy4uL2NvbnN0YW50cy9BY3Rpdml0eUNsaWVudFN0YXRlJztcblxuY29uc3QgREVGQVVMVF9TVEFURSA9IFtdO1xuXG5mdW5jdGlvbiBnZXRDbGllbnRBY3Rpdml0eUlEKHsgY2hhbm5lbERhdGE6IHsgY2xpZW50QWN0aXZpdHlJRCB9ID0ge30gfSkge1xuICByZXR1cm4gY2xpZW50QWN0aXZpdHlJRDtcbn1cblxuZnVuY3Rpb24gZmluZEJ5Q2xpZW50QWN0aXZpdHlJRChjbGllbnRBY3Rpdml0eUlEKSB7XG4gIHJldHVybiBhY3Rpdml0eSA9PiBnZXRDbGllbnRBY3Rpdml0eUlEKGFjdGl2aXR5KSA9PT0gY2xpZW50QWN0aXZpdHlJRDtcbn1cblxuZnVuY3Rpb24gdXBzZXJ0QWN0aXZpdHlXaXRoU29ydChhY3Rpdml0aWVzLCBuZXh0QWN0aXZpdHkpIHtcbiAgY29uc3Qge1xuICAgIGNoYW5uZWxEYXRhOiB7IGNsaWVudEFjdGl2aXR5SUQ6IG5leHRDbGllbnRBY3Rpdml0eUlEIH0gPSB7fSxcbiAgICBmcm9tOiB7IGlkOiBuZXh0RnJvbUlELCByb2xlOiBuZXh0RnJvbVJvbGUgfSA9IHt9LFxuICAgIHR5cGU6IG5leHRUeXBlXG4gIH0gPSBuZXh0QWN0aXZpdHk7XG5cbiAgaWYgKG5leHRUeXBlID09PSAndHlwaW5nJyAmJiBuZXh0RnJvbVJvbGUgPT09ICd1c2VyJykge1xuICAgIHJldHVybiBhY3Rpdml0aWVzO1xuICB9XG5cbiAgY29uc3QgbmV4dFRpbWVzdGFtcCA9IERhdGUucGFyc2UobmV4dEFjdGl2aXR5LnRpbWVzdGFtcCk7XG4gIGNvbnN0IG5leHRBY3Rpdml0aWVzID0gYWN0aXZpdGllcy5maWx0ZXIoKHsgY2hhbm5lbERhdGE6IHsgY2xpZW50QWN0aXZpdHlJRCB9ID0ge30sIGZyb20sIHR5cGUgfSkgPT5cbiAgICAvLyBXZSB3aWxsIHJlbW92ZSBhbGwgXCJ0eXBpbmdcIiBhbmQgXCJzZW5kaW5nIG1lc3NhZ2VzXCIgYWN0aXZpdGllc1xuICAgIC8vIFwiY2xpZW50QWN0aXZpdHlJRFwiIGlzIHVuaXF1ZSBhbmQgdXNlZCB0byB0cmFjayBpZiB0aGUgbWVzc2FnZSBoYXMgYmVlbiBzZW50IGFuZCBlY2hvZWQgYmFjayBmcm9tIHRoZSBzZXJ2ZXJcbiAgICAhKFxuICAgICAgKHR5cGUgPT09ICd0eXBpbmcnICYmIGZyb20uaWQgPT09IG5leHRGcm9tSUQpXG4gICAgICB8fCAobmV4dENsaWVudEFjdGl2aXR5SUQgJiYgY2xpZW50QWN0aXZpdHlJRCA9PT0gbmV4dENsaWVudEFjdGl2aXR5SUQpXG4gICAgKVxuICApO1xuXG4gIC8vIFRoZW4sIGZpbmQgdGhlIHJpZ2h0IChzb3J0ZWQpIHBsYWNlIHRvIGluc2VydCB0aGUgbmV3IGFjdGl2aXR5IGF0LCBiYXNlZCBvbiB0aW1lc3RhbXAsIGFuZCBtdXN0IGJlIGJlZm9yZSBcInR5cGluZ1wiXG4gIC8vIFNpbmNlIGNsb2Nrc2tldyBtaWdodCBoYXBwZW4sIHdlIHdpbGwgaWdub3JlIHRpbWVzdGFtcCBvbiBtZXNzYWdlcyB0aGF0IGFyZSBzZW5kaW5nXG4gIC8vIElmIHdlIGFyZSBpbnNlcnRpbmcgXCJ0eXBpbmdcIiwgd2Ugd2lsbCBhbHdheXMgYXBwZW5kIGl0XG5cbiAgLy8gVE9ETzogW1A0XSBNb3ZlIFwidHlwaW5nXCIgaW50byBDb25zdGFudHMuQWN0aXZpdHlUeXBlXG4gIGNvbnN0IGluZGV4VG9JbnNlcnQgPSBuZXh0QWN0aXZpdHkudHlwZSA9PT0gJ3R5cGluZycgPyAtMSA6IG5leHRBY3Rpdml0aWVzLmZpbmRJbmRleCgoeyBjaGFubmVsRGF0YTogeyBzdGF0ZSB9ID0ge30sIHRpbWVzdGFtcCwgdHlwZSB9KSA9PlxuICAgIChEYXRlLnBhcnNlKHRpbWVzdGFtcCkgPiBuZXh0VGltZXN0YW1wICYmIHN0YXRlICE9PSBTRU5ESU5HICYmIHN0YXRlICE9PSBTRU5EX0ZBSUxFRCkgfHwgdHlwZSA9PT0gJ3R5cGluZydcbiAgKTtcblxuICAvLyBJZiBubyByaWdodCBwbGFjZSBhcmUgZm91bmQsIGFwcGVuZCBpdFxuICBuZXh0QWN0aXZpdGllcy5zcGxpY2UofmluZGV4VG9JbnNlcnQgPyBpbmRleFRvSW5zZXJ0IDogbmV4dEFjdGl2aXRpZXMubGVuZ3RoLCAwLCBuZXh0QWN0aXZpdHkpO1xuXG4gIHJldHVybiBuZXh0QWN0aXZpdGllcztcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKHN0YXRlID0gREVGQVVMVF9TVEFURSwgeyBtZXRhLCBwYXlsb2FkLCB0eXBlIH0pIHtcbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSBERUxFVEVfQUNUSVZJVFk6XG4gICAgICBzdGF0ZSA9IHVwZGF0ZUluKHN0YXRlLCBbKHsgaWQgfSkgPT4gaWQgPT09IHBheWxvYWQuYWN0aXZpdHlJRF0pO1xuICAgICAgYnJlYWs7XG5cbiAgICBjYXNlIE1BUktfQUNUSVZJVFk6XG4gICAgICBzdGF0ZSA9IHVwZGF0ZUluKHN0YXRlLCBbKHsgaWQgfSkgPT4gaWQgPT09IHBheWxvYWQuYWN0aXZpdHlJRCwgJ2NoYW5uZWxEYXRhJywgcGF5bG9hZC5uYW1lXSwgKCkgPT4gcGF5bG9hZC52YWx1ZSk7XG4gICAgICBicmVhaztcblxuICAgIGNhc2UgUE9TVF9BQ1RJVklUWV9QRU5ESU5HOlxuICAgICAgc3RhdGUgPSB1cHNlcnRBY3Rpdml0eVdpdGhTb3J0KHN0YXRlLCB1cGRhdGVJbihwYXlsb2FkLmFjdGl2aXR5LCBbJ2NoYW5uZWxEYXRhJywgJ3N0YXRlJ10sICgpID0+IFNFTkRJTkcpKTtcbiAgICAgIGJyZWFrO1xuXG4gICAgY2FzZSBQT1NUX0FDVElWSVRZX1JFSkVDVEVEOlxuICAgICAgc3RhdGUgPSB1cGRhdGVJbihzdGF0ZSwgW2ZpbmRCeUNsaWVudEFjdGl2aXR5SUQobWV0YS5jbGllbnRBY3Rpdml0eUlEKSwgJ2NoYW5uZWxEYXRhJywgJ3N0YXRlJ10sICgpID0+IFNFTkRfRkFJTEVEKTtcbiAgICAgIGJyZWFrO1xuXG4gICAgY2FzZSBQT1NUX0FDVElWSVRZX0ZVTEZJTExFRDpcbiAgICAgIHN0YXRlID0gdXBkYXRlSW4oc3RhdGUsIFtmaW5kQnlDbGllbnRBY3Rpdml0eUlEKG1ldGEuY2xpZW50QWN0aXZpdHlJRCldLCBhY3Rpdml0eSA9PlxuICAgICAgICAvLyBXZSB3aWxsIHJlcGxhY2UgdGhlIGFjdGl2aXR5IHdpdGggdGhlIHZlcnNpb24gZnJvbSB0aGUgc2VydmVyXG4gICAgICAgIHVwZGF0ZUluKHBheWxvYWQuYWN0aXZpdHksIFsnY2hhbm5lbERhdGEnLCAnc3RhdGUnXSwgKCkgPT4gU0VOVClcbiAgICAgICk7XG5cbiAgICAgIGJyZWFrO1xuXG4gICAgY2FzZSBJTkNPTUlOR19BQ1RJVklUWTpcbiAgICAgIC8vIFVwZGF0ZUFjdGl2aXR5IGlzIG5vdCBzdXBwb3J0ZWQgcmlnaHQgbm93IGJlY2F1c2Ugd2UgaWdub3JlIGR1cGxpY2F0ZWQgYWN0aXZpdHkgSURcbiAgICAgIGlmICghfnN0YXRlLmZpbmRJbmRleCgoeyBpZCB9KSA9PiBpZCA9PT0gcGF5bG9hZC5hY3Rpdml0eS5pZCkpIHtcbiAgICAgICAgc3RhdGUgPSB1cHNlcnRBY3Rpdml0eVdpdGhTb3J0KHN0YXRlLCBwYXlsb2FkLmFjdGl2aXR5KTtcbiAgICAgIH1cblxuICAgICAgYnJlYWs7XG5cbiAgICBkZWZhdWx0OiBicmVhaztcbiAgfVxuXG4gIHJldHVybiBzdGF0ZTtcbn1cbiJdfQ==